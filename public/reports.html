<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - NanoChip</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <span>NanoChip</span>
                </div>
            </div>
            <ul class="sidebar-nav">
                <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                <li><a href="/clients"><i class="fas fa-users"></i> إدارة العملاء</a></li>
                <li><a href="/expenses"><i class="fas fa-money-bill-wave"></i> المصروفات</a></li>
                <li><a href="/revenues"><i class="fas fa-chart-line"></i> الإيرادات</a></li>
                <li><a href="/reports" class="active"><i class="fas fa-file-alt"></i> التقارير</a></li>
                <li><a href="/profile"><i class="fas fa-user-cog"></i> الملف الشخصي</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li>
            </ul>
        </nav>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <span>NanoChip</span>
                    </div>
                    
                    <div class="header-actions">
                        <div class="user-info">
                            <span class="user-name">المستخدم</span>
                            <div class="user-avatar">م</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <div class="page-header fade-in">
                    <h1 class="page-title">
                        <i class="fas fa-file-alt"></i>
                        التقارير المالية
                    </h1>
                    <p class="page-subtitle">تحليل شامل لأداءك المالي</p>
                </div>

                <!-- Report Filters -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-filter"></i>
                            فلاتر التقرير
                        </h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div class="form-group">
                            <label class="form-label" for="reportPeriod">
                                <i class="fas fa-calendar"></i>
                                الفترة الزمنية
                            </label>
                            <select id="reportPeriod" class="form-select">
                                <option value="today">اليوم</option>
                                <option value="week">الأسبوع الحالي</option>
                                <option value="month" selected>الشهر الحالي</option>
                                <option value="quarter">الربع الحالي</option>
                                <option value="year">السنة الحالية</option>
                                <option value="custom">فترة مخصصة</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="customDateRange" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-calendar-alt"></i>
                                الفترة المخصصة
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="customDateFrom" class="form-input" placeholder="من">
                                <input type="date" id="customDateTo" class="form-input" placeholder="إلى">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="reportClient">
                                <i class="fas fa-user"></i>
                                العميل
                            </label>
                            <select id="reportClient" class="form-select">
                                <option value="">جميع العملاء</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-cog"></i>
                                إجراءات
                            </label>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i>
                                    إنشاء التقرير
                                </button>
                                <button class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="stats-grid slide-in-right" id="reportSummary">
                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-title">إجمالي الإيرادات</div>
                            <div class="stat-icon success">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="reportRevenues">0</div>
                        <div class="stat-change positive" id="reportRevenuesChange">+0%</div>
                    </div>

                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-title">إجمالي المصروفات</div>
                            <div class="stat-icon danger">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="reportExpenses">0</div>
                        <div class="stat-change negative" id="reportExpensesChange">-0%</div>
                    </div>

                    <div class="stat-card primary">
                        <div class="stat-header">
                            <div class="stat-title">صافي الربح</div>
                            <div class="stat-icon primary">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="reportProfit">0</div>
                        <div class="stat-change" id="reportProfitChange">0%</div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-title">هامش الربح</div>
                            <div class="stat-icon warning">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="reportMargin">0%</div>
                        <div class="stat-change" id="reportMarginChange">0%</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <!-- Revenue vs Expenses Chart -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar"></i>
                                مقارنة الإيرادات والمصروفات
                            </h3>
                        </div>
                        <div id="revenueExpenseChart" style="height: 300px; display: flex; align-items: center; justify-content: center; color: var(--text-color); opacity: 0.6;">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                                <p>الرسم البياني سيظهر هنا بعد إنشاء التقرير</p>
                            </div>
                        </div>
                    </div>

                    <!-- Top Clients Chart -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users"></i>
                                أفضل العملاء
                            </h3>
                        </div>
                        <div id="topClientsChart" style="height: 300px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد بيانات عملاء
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Report Table -->
                <div class="card slide-in-right">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-table"></i>
                            تقرير مفصل
                        </h3>
                        <div>
                            <button class="btn btn-outline" onclick="toggleReportView()">
                                <i class="fas fa-exchange-alt"></i>
                                <span id="viewToggleText">عرض حسب العميل</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table" id="detailedReportTable">
                            <thead id="reportTableHead">
                                <tr>
                                    <th>#</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>العميل</th>
                                    <th>المبلغ</th>
                                    <th>الوصف</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                                        <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                        اختر الفترة الزمنية وانقر على "إنشاء التقرير"
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Financial Insights -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-lightbulb"></i>
                            رؤى مالية
                        </h3>
                    </div>
                    <div id="financialInsights">
                        <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                            <i class="fas fa-lightbulb" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            الرؤى المالية ستظهر هنا بعد إنشاء التقرير
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="bottom-nav-content">
                <a href="/dashboard" class="bottom-nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>الرئيسية</span>
                </a>
                <a href="/clients" class="bottom-nav-item">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </a>
                <a href="/expenses" class="bottom-nav-item">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>المصروفات</span>
                </a>
                <a href="/revenues" class="bottom-nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>الإيرادات</span>
                </a>
                <a href="/reports" class="bottom-nav-item active">
                    <i class="fas fa-file-alt"></i>
                    <span>التقارير</span>
                </a>
            </div>
        </nav>
    </div>

    <script src="/js/app.js"></script>
    <script>
        class ReportsManager {
            constructor() {
                this.data = { clients: [], expenses: [], revenues: [] };
                this.currentReportData = [];
                this.reportViewMode = 'transactions'; // 'transactions' or 'clients'
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.populateClientSelect();
                this.generateReport(); // Generate default report
            }

            async loadData() {
                await window.app.loadData();
                this.data = window.app.data;
            }

            setupEventListeners() {
                // Period change
                document.getElementById('reportPeriod').addEventListener('change', (e) => {
                    const customRange = document.getElementById('customDateRange');
                    if (e.target.value === 'custom') {
                        customRange.style.display = 'block';
                    } else {
                        customRange.style.display = 'none';
                        this.generateReport();
                    }
                });

                // Custom date range
                document.getElementById('customDateFrom').addEventListener('change', this.generateReport.bind(this));
                document.getElementById('customDateTo').addEventListener('change', this.generateReport.bind(this));
                
                // Client filter
                document.getElementById('reportClient').addEventListener('change', this.generateReport.bind(this));
            }

            populateClientSelect() {
                const select = document.getElementById('reportClient');
                select.innerHTML = '<option value="">جميع العملاء</option>';
                
                this.data.clients.forEach(client => {
                    const option = new Option(client.name, client.clientId);
                    select.add(option);
                });
            }

            getDateRange() {
                const period = document.getElementById('reportPeriod').value;
                const now = new Date();
                
                switch (period) {
                    case 'today':
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        return { start: today, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                    
                    case 'week':
                        const weekStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return { start: weekStart, end: now };
                    
                    case 'month':
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        return { start: monthStart, end: now };
                    
                    case 'quarter':
                        const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                        return { start: quarterStart, end: now };
                    
                    case 'year':
                        const yearStart = new Date(now.getFullYear(), 0, 1);
                        return { start: yearStart, end: now };
                    
                    case 'custom':
                        const fromDate = document.getElementById('customDateFrom').value;
                        const toDate = document.getElementById('customDateTo').value;
                        if (fromDate && toDate) {
                            return { 
                                start: new Date(fromDate), 
                                end: new Date(new Date(toDate).getTime() + 24 * 60 * 60 * 1000)
                            };
                        }
                        return { start: new Date(0), end: now };
                    
                    default:
                        return { start: new Date(0), end: now };
                }
            }

            filterDataByDateAndClient(data, dateRange, clientId = '') {
                return data.filter(item => {
                    const itemDate = new Date(item.createdAt);
                    const inDateRange = itemDate >= dateRange.start && itemDate <= dateRange.end;
                    const matchesClient = !clientId || item.clientId === clientId;
                    return inDateRange && matchesClient;
                });
            }

            generateReport() {
                const dateRange = this.getDateRange();
                const clientId = document.getElementById('reportClient').value;
                
                // Filter data
                const filteredRevenues = this.filterDataByDateAndClient(this.data.revenues, dateRange, clientId);
                const filteredExpenses = this.filterDataByDateAndClient(this.data.expenses, dateRange, clientId);
                
                // Calculate totals
                const totalRevenues = filteredRevenues.reduce((sum, item) => sum + item.amount, 0);
                const totalExpenses = filteredExpenses.reduce((sum, item) => sum + item.amount, 0);
                const netProfit = totalRevenues - totalExpenses;
                const profitMargin = totalRevenues > 0 ? (netProfit / totalRevenues) * 100 : 0;
                
                // Update summary cards
                this.updateSummaryCards(totalRevenues, totalExpenses, netProfit, profitMargin);
                
                // Combine transactions for detailed report
                this.currentReportData = [
                    ...filteredRevenues.map(item => ({ ...item, type: 'revenue' })),
                    ...filteredExpenses.map(item => ({ ...item, type: 'expense' }))
                ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render report table
                this.renderReportTable();
                
                // Generate charts
                this.generateCharts(filteredRevenues, filteredExpenses);
                
                // Generate insights
                this.generateInsights(totalRevenues, totalExpenses, netProfit, profitMargin);
            }

            updateSummaryCards(revenues, expenses, profit, margin) {
                // Animate values
                this.animateValue('reportRevenues', revenues);
                this.animateValue('reportExpenses', expenses);
                this.animateValue('reportProfit', profit);
                
                // Update margin
                document.getElementById('reportMargin').textContent = margin.toFixed(1) + '%';
                
                // Update profit color
                const profitElement = document.getElementById('reportProfit');
                const profitChangeElement = document.getElementById('reportProfitChange');
                
                if (profit > 0) {
                    profitElement.style.color = 'var(--success-color)';
                    profitChangeElement.className = 'stat-change positive';
                    profitChangeElement.textContent = '+' + this.formatCurrency(profit);
                } else if (profit < 0) {
                    profitElement.style.color = 'var(--danger-color)';
                    profitChangeElement.className = 'stat-change negative';
                    profitChangeElement.textContent = this.formatCurrency(profit);
                } else {
                    profitElement.style.color = 'var(--text-color)';
                    profitChangeElement.className = 'stat-change';
                    profitChangeElement.textContent = this.formatCurrency(0);
                }
            }

            animateValue(elementId, value) {
                const element = document.getElementById(elementId);
                const currentValue = parseInt(element.textContent.replace(/[^\d]/g, '')) || 0;
                
                const startTime = performance.now();
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / 1000, 1);
                    
                    const current = currentValue + (Math.abs(value) - currentValue) * window.app.easeOutCubic(progress);
                    element.textContent = this.formatCurrency(value < 0 ? -current : current);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                requestAnimationFrame(animate);
            }

            renderReportTable() {
                const tbody = document.querySelector('#detailedReportTable tbody');
                const thead = document.querySelector('#reportTableHead');
                
                if (this.reportViewMode === 'transactions') {
                    thead.innerHTML = `
                        <tr>
                            <th>#</th>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>العميل</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                        </tr>
                    `;
                    
                    if (this.currentReportData.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                                    <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                    لا توجد معاملات في الفترة المحددة
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tbody.innerHTML = this.currentReportData.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${window.app.formatDate(item.createdAt)}</td>
                            <td>
                                <span class="badge ${item.type === 'revenue' ? 'success' : 'danger'}">
                                    <i class="fas fa-${item.type === 'revenue' ? 'arrow-up' : 'arrow-down'}"></i>
                                    ${item.type === 'revenue' ? 'إيراد' : 'مصروف'}
                                </span>
                            </td>
                            <td>${window.app.getClientName(item.clientId)}</td>
                            <td style="color: var(--${item.type === 'revenue' ? 'success' : 'danger'}-color); font-weight: 600;">
                                ${this.formatCurrency(item.amount)}
                            </td>
                            <td>${item.notes || item.product || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    this.renderClientSummaryTable();
                }
            }

            renderClientSummaryTable() {
                const thead = document.querySelector('#reportTableHead');
                const tbody = document.querySelector('#detailedReportTable tbody');
                
                thead.innerHTML = `
                    <tr>
                        <th>#</th>
                        <th>العميل</th>
                        <th>الإيرادات</th>
                        <th>المصروفات</th>
                        <th>صافي الربح</th>
                        <th>عدد المعاملات</th>
                    </tr>
                `;
                
                // Group data by client
                const clientSummary = {};
                
                this.currentReportData.forEach(item => {
                    const clientId = item.clientId;
                    if (!clientSummary[clientId]) {
                        clientSummary[clientId] = {
                            name: window.app.getClientName(clientId),
                            revenues: 0,
                            expenses: 0,
                            transactions: 0
                        };
                    }
                    
                    if (item.type === 'revenue') {
                        clientSummary[clientId].revenues += item.amount;
                    } else {
                        clientSummary[clientId].expenses += item.amount;
                    }
                    clientSummary[clientId].transactions++;
                });
                
                const sortedClients = Object.entries(clientSummary)
                    .sort((a, b) => (b[1].revenues - b[1].expenses) - (a[1].revenues - a[1].expenses));
                
                if (sortedClients.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                                <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                                لا توجد بيانات عملاء في الفترة المحددة
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = sortedClients.map(([clientId, data], index) => {
                    const profit = data.revenues - data.expenses;
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">
                                        ${data.name.charAt(0)}
                                    </div>
                                    ${data.name}
                                </div>
                            </td>
                            <td style="color: var(--success-color); font-weight: 600;">
                                ${this.formatCurrency(data.revenues)}
                            </td>
                            <td style="color: var(--danger-color); font-weight: 600;">
                                ${this.formatCurrency(data.expenses)}
                            </td>
                            <td style="color: var(--${profit >= 0 ? 'success' : 'danger'}-color); font-weight: 600;">
                                ${this.formatCurrency(profit)}
                            </td>
                            <td>
                                <span class="badge primary">${data.transactions}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            generateCharts(revenues, expenses) {
                this.generateRevenueExpenseChart(revenues, expenses);
                this.generateTopClientsChart(revenues, expenses);
            }

            generateRevenueExpenseChart(revenues, expenses) {
                const container = document.getElementById('revenueExpenseChart');
                const totalRevenues = revenues.reduce((sum, item) => sum + item.amount, 0);
                const totalExpenses = expenses.reduce((sum, item) => sum + item.amount, 0);
                
                if (totalRevenues === 0 && totalExpenses === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; color: var(--text-color); opacity: 0.6;">
                            <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                            <p>لا توجد بيانات للعرض</p>
                        </div>
                    `;
                    return;
                }
                
                const maxValue = Math.max(totalRevenues, totalExpenses);
                const revenueHeight = (totalRevenues / maxValue) * 200;
                const expenseHeight = (totalExpenses / maxValue) * 200;
                
                container.innerHTML = `
                    <div style="display: flex; align-items: end; justify-content: center; gap: 40px; height: 250px; padding: 20px;">
                        <div style="text-align: center;">
                            <div style="width: 60px; height: ${revenueHeight}px; background: var(--gradient-success); border-radius: 8px 8px 0 0; margin-bottom: 10px; position: relative;">
                                <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; color: var(--success-color);">
                                    ${this.formatCurrency(totalRevenues)}
                                </div>
                            </div>
                            <div style="font-weight: 600; color: var(--success-color);">الإيرادات</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="width: 60px; height: ${expenseHeight}px; background: var(--gradient-danger); border-radius: 8px 8px 0 0; margin-bottom: 10px; position: relative;">
                                <div style="position: absolute; top: -30px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; font-weight: 600; color: var(--danger-color);">
                                    ${this.formatCurrency(totalExpenses)}
                                </div>
                            </div>
                            <div style="font-weight: 600; color: var(--danger-color);">المصروفات</div>
                        </div>
                    </div>
                `;
            }

            generateTopClientsChart(revenues, expenses) {
                const container = document.getElementById('topClientsChart');
                
                // Group by client
                const clientData = {};
                
                [...revenues, ...expenses].forEach(item => {
                    const clientId = item.clientId;
                    if (!clientData[clientId]) {
                        clientData[clientId] = {
                            name: window.app.getClientName(clientId),
                            revenues: 0,
                            expenses: 0
                        };
                    }
                    
                    if (revenues.includes(item)) {
                        clientData[clientId].revenues += item.amount;
                    } else {
                        clientData[clientId].expenses += item.amount;
                    }
                });
                
                const sortedClients = Object.entries(clientData)
                    .map(([id, data]) => ({ ...data, profit: data.revenues - data.expenses }))
                    .sort((a, b) => b.profit - a.profit)
                    .slice(0, 5);
                
                if (sortedClients.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.6;">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            لا توجد بيانات عملاء
                        </div>
                    `;
                    return;
                }
                
                const maxProfit = Math.max(...sortedClients.map(c => Math.abs(c.profit)));
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        ${sortedClients.map((client, index) => {
                            const percentage = maxProfit > 0 ? (Math.abs(client.profit) / maxProfit) * 100 : 0;
                            return `
                                <div style="margin-bottom: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <span style="font-weight: 600;">${client.name}</span>
                                        <span style="color: var(--${client.profit >= 0 ? 'success' : 'danger'}-color); font-weight: 600;">
                                            ${this.formatCurrency(client.profit)}
                                        </span>
                                    </div>
                                    <div style="background: rgba(102, 126, 234, 0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: var(--${client.profit >= 0 ? 'gradient-success' : 'gradient-danger'}); border-radius: 4px;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            generateInsights(revenues, expenses, profit, margin) {
                const container = document.getElementById('financialInsights');
                const insights = [];
                
                // Performance insights
                if (profit > 0) {
                    insights.push({
                        type: 'success',
                        icon: 'fas fa-thumbs-up',
                        title: 'أداء ممتاز!',
                        description: `تحقق ربح قدره ${this.formatCurrency(profit)} بهامش ربح ${margin.toFixed(1)}%`
                    });
                } else if (profit < 0) {
                    insights.push({
                        type: 'danger',
                        icon: 'fas fa-exclamation-triangle',
                        title: 'تحذير: خسارة مالية',
                        description: `هناك خسارة قدرها ${this.formatCurrency(Math.abs(profit))}. راجع المصروفات`
                    });
                }
                
                // Margin insights
                if (margin > 30) {
                    insights.push({
                        type: 'success',
                        icon: 'fas fa-chart-line',
                        title: 'هامش ربح ممتاز',
                        description: 'هامش الربح أعلى من 30% وهو مؤشر ممتاز'
                    });
                } else if (margin < 10 && margin > 0) {
                    insights.push({
                        type: 'warning',
                        icon: 'fas fa-chart-line',
                        title: 'هامش ربح منخفض',
                        description: 'هامش الربح أقل من 10%. حاول تقليل المصروفات أو زيادة الأسعار'
                    });
                }
                
                // Expense insights
                if (expenses > revenues * 0.8) {
                    insights.push({
                        type: 'warning',
                        icon: 'fas fa-money-bill-wave',
                        title: 'مصروفات مرتفعة',
                        description: 'المصروفات تشكل أكثر من 80% من الإيرادات'
                    });
                }
                
                // Revenue insights
                if (revenues === 0) {
                    insights.push({
                        type: 'warning',
                        icon: 'fas fa-chart-line',
                        title: 'لا توجد إيرادات',
                        description: 'لم يتم تسجيل أي إيرادات في الفترة المحددة'
                    });
                }
                
                if (insights.length === 0) {
                    insights.push({
                        type: 'primary',
                        icon: 'fas fa-info-circle',
                        title: 'ابدأ بتسجيل المعاملات',
                        description: 'أضف إيرادات ومصروفات لتحصل على رؤى مالية مفيدة'
                    });
                }
                
                container.innerHTML = `
                    <div style="display: grid; gap: 15px;">
                        ${insights.map(insight => `
                            <div class="insight-item ${insight.type}">
                                <div class="insight-icon">
                                    <i class="${insight.icon}"></i>
                                </div>
                                <div class="insight-content">
                                    <h4 class="insight-title">${insight.title}</h4>
                                    <p class="insight-description">${insight.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('ar-EG', {
                    style: 'currency',
                    currency: 'EGP',
                    minimumFractionDigits: 0
                }).format(amount);
            }
        }

        // Global functions
        function generateReport() {
            window.reportsManager.generateReport();
        }

        function toggleReportView() {
            const manager = window.reportsManager;
            const toggleText = document.getElementById('viewToggleText');
            
            if (manager.reportViewMode === 'transactions') {
                manager.reportViewMode = 'clients';
                toggleText.textContent = 'عرض المعاملات';
            } else {
                manager.reportViewMode = 'transactions';
                toggleText.textContent = 'عرض حسب العميل';
            }
            
            manager.renderReportTable();
        }

        function exportReport() {
            const data = window.reportsManager.currentReportData;
            if (data.length === 0) {
                window.app.showAlert('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "التاريخ,النوع,العميل,المبلغ,الوصف\n"
                + data.map(item => 
                    `"${window.app.formatDate(item.createdAt)}","${item.type === 'revenue' ? 'إيراد' : 'مصروف'}","${window.app.getClientName(item.clientId)}","${item.amount}","${item.notes || item.product || ''}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "financial_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.app.showAlert('تم تصدير التقرير بنجاح', 'success');
        }

        // Initialize reports manager
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                window.reportsManager = new ReportsManager();
            }, 100);
        });
    </script>

    <style>
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid;
        }

        .insight-item.success {
            background: rgba(74, 222, 128, 0.1);
            border-color: var(--success-color);
        }

        .insight-item.warning {
            background: rgba(251, 191, 36, 0.1);
            border-color: var(--warning-color);
        }

        .insight-item.danger {
            background: rgba(248, 113, 113, 0.1);
            border-color: var(--danger-color);
        }

        .insight-item.primary {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--primary-color);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .insight-item.success .insight-icon {
            background: var(--success-color);
            color: white;
        }

        .insight-item.warning .insight-icon {
            background: var(--warning-color);
            color: white;
        }

        .insight-item.danger .insight-icon {
            background: var(--danger-color);
            color: white;
        }

        .insight-item.primary .insight-icon {
            background: var(--primary-color);
            color: white;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .insight-description {
            color: var(--text-color);
            opacity: 0.8;
            line-height: 1.5;
        }
    </style>
</body>
</html>